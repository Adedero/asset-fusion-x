import{s as ue,aJ as ce,aG as le,aI as fe}from"./BCrY3s8v.js";var de=Object.defineProperty,he=Object.defineProperties,pe=Object.getOwnPropertyDescriptors,J=Object.getOwnPropertySymbols,ye=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,H=(e,t,r)=>t in e?de(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,_=(e,t)=>{for(var r in t||(t={}))ye.call(t,r)&&H(e,r,t[r]);if(J)for(var r of J(t))me.call(t,r)&&H(e,r,t[r]);return e},R=(e,t)=>he(e,pe(t)),ge=class extends Error{constructor(e,t,r){super(t||e.toString(),{cause:r}),this.status=e,this.statusText=t,this.error=r}},ve=async(e,t)=>{var r,n,s,a,i,u;let l=t||{};const o={onRequest:[t?.onRequest],onResponse:[t?.onResponse],onSuccess:[t?.onSuccess],onError:[t?.onError],onRetry:[t?.onRetry]};if(!t||!t?.plugins)return{url:e,options:l,hooks:o};for(const c of t?.plugins||[]){if(c.init){const f=await((r=c.init)==null?void 0:r.call(c,e.toString(),t));l=f.options||l,e=f.url}o.onRequest.push((n=c.hooks)==null?void 0:n.onRequest),o.onResponse.push((s=c.hooks)==null?void 0:s.onResponse),o.onSuccess.push((a=c.hooks)==null?void 0:a.onSuccess),o.onError.push((i=c.hooks)==null?void 0:i.onError),o.onRetry.push((u=c.hooks)==null?void 0:u.onRetry)}return{url:e,options:l,hooks:o}},V=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(){return this.options.delay}},we=class{constructor(e){this.options=e}shouldAttemptRetry(e,t){return this.options.shouldRetry?Promise.resolve(e<this.options.attempts&&this.options.shouldRetry(t)):Promise.resolve(e<this.options.attempts)}getDelay(e){return Math.min(this.options.maxDelay,this.options.baseDelay*2**e)}};function _e(e){if(typeof e=="number")return new V({type:"linear",attempts:e,delay:1e3});switch(e.type){case"linear":return new V(e);case"exponential":return new we(e);default:throw new Error("Invalid retry strategy")}}var Re=async e=>{const t={},r=async n=>typeof n=="function"?await n():n;if(e?.auth){if(e.auth.type==="Bearer"){const n=await r(e.auth.token);if(!n)return t;t.authorization=`Bearer ${n}`}else if(e.auth.type==="Basic"){const n=r(e.auth.username),s=r(e.auth.password);if(!n||!s)return t;t.authorization=`Basic ${btoa(`${n}:${s}`)}`}else if(e.auth.type==="Custom"){const n=r(e.auth.value);if(!n)return t;t.authorization=`${r(e.auth.prefix)} ${n}`}}return t},be=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function Te(e){const t=e.headers.get("content-type"),r=new Set(["image/svg","application/xml","application/xhtml","application/html"]);if(!t)return"json";const n=t.split(";").shift()||"";return be.test(n)?"json":r.has(n)||n.startsWith("text/")?"text":"blob"}function Se(e){try{return JSON.parse(e),!0}catch{return!1}}function Y(e){if(e===void 0)return!1;const t=typeof e;return t==="string"||t==="number"||t==="boolean"||t===null?!0:t!=="object"?!1:Array.isArray(e)?!0:e.buffer?!1:e.constructor&&e.constructor.name==="Object"||typeof e.toJSON=="function"}function G(e){try{return JSON.parse(e)}catch{return e}}function z(e){return typeof e=="function"}function Pe(e){if(e?.customFetchImpl)return e.customFetchImpl;if(typeof globalThis<"u"&&z(globalThis.fetch))return globalThis.fetch;if(typeof window<"u"&&z(window.fetch))return window.fetch;throw new Error("No fetch implementation found")}async function Oe(e){const t=new Headers(e?.headers),r=await Re(e);for(const[n,s]of Object.entries(r||{}))t.set(n,s);if(!t.has("content-type")){const n=Ee(e?.body);n&&t.set("content-type",n)}return t}function Ee(e){return Y(e)?"application/json":null}function Ae(e){if(!e?.body)return null;const t=new Headers(e?.headers);if(Y(e.body)&&!t.has("content-type")){for(const[r,n]of Object.entries(e?.body))n instanceof Date&&(e.body[r]=n.toISOString());return JSON.stringify(e.body)}return e.body}function Ue(e,t){var r;if(t?.method)return t.method.toUpperCase();if(e.startsWith("@")){const n=(r=e.split("@")[1])==null?void 0:r.split("/")[0];return K.includes(n)?n.toUpperCase():t?.body?"POST":"GET"}return t?.body?"POST":"GET"}function Le(e,t){let r;return!e?.signal&&e?.timeout&&(r=setTimeout(()=>t?.abort(),e?.timeout)),{abortTimeout:r,clearTimeout:()=>{r&&clearTimeout(r)}}}var Ie=class Z extends Error{constructor(t,r){super(r||JSON.stringify(t,null,2)),this.issues=t,Object.setPrototypeOf(this,Z.prototype)}};async function C(e,t){let r=await e["~standard"].validate(t);if(r.issues)throw new Ie(r.issues);return r.value}var K=["get","post","put","patch","delete"],Ne=e=>({id:"apply-schema",name:"Apply Schema",version:"1.0.0",async init(t,r){var n,s,a,i;const u=((s=(n=e.plugins)==null?void 0:n.find(l=>{var o;return(o=l.schema)!=null&&o.config?t.startsWith(l.schema.config.baseURL||"")||t.startsWith(l.schema.config.prefix||""):!1}))==null?void 0:s.schema)||e.schema;if(u){let l=t;(a=u.config)!=null&&a.prefix&&l.startsWith(u.config.prefix)&&(l=l.replace(u.config.prefix,""),u.config.baseURL&&(t=t.replace(u.config.prefix,u.config.baseURL))),(i=u.config)!=null&&i.baseURL&&l.startsWith(u.config.baseURL)&&(l=l.replace(u.config.baseURL,""));const o=u.schema[l];if(o){let c=R(_({},r),{method:o.method,output:o.output});return r?.disableValidation||(c=R(_({},c),{body:o.input?await C(o.input,r?.body):r?.body,params:o.params?await C(o.params,r?.params):r?.params,query:o.query?await C(o.query,r?.query):r?.query})),{url:t,options:c}}}return{url:t,options:r}}}),xe=e=>{async function t(r,n){const s=R(_(_({},e),n),{plugins:[...e?.plugins||[],Ne(e||{})]});if(e?.catchAllError)try{return await F(r,s)}catch(a){return{data:null,error:{status:500,statusText:"Fetch Error",message:"Fetch related error. Captured by catchAllError option. See error property for more details.",error:a}}}return await F(r,s)}return t};function je(e,t){let{baseURL:r,params:n,query:s}=t||{query:{},params:{},baseURL:""},a=e.startsWith("http")?e.split("/").slice(0,3).join("/"):r||"";if(e.startsWith("@")){const f=e.toString().split("@")[1].split("/")[0];K.includes(f)&&(e=e.replace(`@${f}/`,"/"))}a.endsWith("/")||(a+="/");let[i,u]=e.replace(a,"").split("?");const l=new URLSearchParams(u);for(const[f,h]of Object.entries(s||{}))h!=null&&l.set(f,String(h));if(n)if(Array.isArray(n)){const f=i.split("/").filter(h=>h.startsWith(":"));for(const[h,d]of f.entries()){const m=n[h];i=i.replace(d,m)}}else for(const[f,h]of Object.entries(n))i=i.replace(`:${f}`,String(h));i=i.split("/").map(encodeURIComponent).join("/"),i.startsWith("/")&&(i=i.slice(1));let o=l.toString();return o=o.length>0?`?${o}`.replace(/\+/g,"%20"):"",a.startsWith("http")?new URL(`${i}${o}`,a):`${a}${i}${o}`}var F=async(e,t)=>{var r,n,s,a,i,u,l,o;const{hooks:c,url:f,options:h}=await ve(e,t),d=Pe(h),m=new AbortController,O=(r=h.signal)!=null?r:m.signal,E=je(f,h),I=Ae(h),U=await Oe(h),A=Ue(f,h);let y=R(_({},h),{url:E,headers:U,body:I,method:A,signal:O});for(const v of c.onRequest)if(v){const g=await v(y);g instanceof Object&&(y=g)}("pipeTo"in y&&typeof y.pipeTo=="function"||typeof((n=t?.body)==null?void 0:n.pipe)=="function")&&("duplex"in y||(y.duplex="half"));const{clearTimeout:k}=Le(h,m);let p=await d(y.url,y);k();const M={response:p,request:y};for(const v of c.onResponse)if(v){const g=await v(R(_({},M),{response:(s=t?.hookOptions)!=null&&s.cloneResponse?p.clone():p}));g instanceof Response?p=g:g instanceof Object&&(p=g.response)}if(p.ok){if(!(y.method!=="HEAD"))return{data:"",error:null};const g=Te(p),b={data:"",response:p,request:y};if(g==="json"||g==="text"){const T=await p.text(),ae=await((a=y.jsonParser)!=null?a:G)(T);b.data=ae}else b.data=await p[g]();y?.output&&y.output&&!y.disableValidation&&(b.data=await C(y.output,b.data));for(const T of c.onSuccess)T&&await T(R(_({},b),{response:(i=t?.hookOptions)!=null&&i.cloneResponse?p.clone():p}));return t?.throw?b.data:{data:b.data,error:null}}const oe=(u=t?.jsonParser)!=null?u:G,N=await p.text(),W=Se(N),D=W?await oe(N):null,ie={response:p,responseText:N,request:y,error:R(_({},D),{status:p.status,statusText:p.statusText})};for(const v of c.onError)v&&await v(R(_({},ie),{response:(l=t?.hookOptions)!=null&&l.cloneResponse?p.clone():p}));if(t?.retry){const v=_e(t.retry),g=(o=t.retryAttempt)!=null?o:0;if(await v.shouldAttemptRetry(g,p)){for(const T of c.onRetry)T&&await T(M);const b=v.getDelay(g);return await new Promise(T=>setTimeout(T,b)),await F(e,R(_({},t),{retryAttempt:g+1}))}}if(t?.throw)throw new ge(p.status,p.statusText,W?D:N);return{data:null,error:R(_({},D),{status:p.status,statusText:p.statusText})}},qe={},Ce={};const $=Object.create(null),L=e=>qe||globalThis.Deno?.env.toObject()||globalThis.__env__||(e?$:globalThis),P=new Proxy($,{get(e,t){return L()[t]??$[t]},has(e,t){const r=L();return t in r||t in $},set(e,t,r){const n=L(!0);return n[t]=r,!0},deleteProperty(e,t){if(!t)return!1;const r=L(!0);return delete r[t],!0},ownKeys(){const e=L(!0);return Object.keys(e)}});function $e(e){return e?e!=="false":!1}const ke=typeof process<"u"&&Ce&&"production"||"";ke==="test"||$e(P.TEST);class ee extends Error{constructor(t,r){super(t),this.name="BetterAuthError",this.message=t,this.cause=r,this.stack=""}}function De(e){try{return new URL(e).pathname!=="/"}catch{throw new ee(`Invalid base URL: ${e}. Please provide a valid base URL.`)}}function B(e,t="/api/auth"){return De(e)?e:(t=t.startsWith("/")?t:`/${t}`,`${e.replace(/\/+$/,"")}${t}`)}function Be(e,t,r){if(e)return B(e,t);const n=P.BETTER_AUTH_URL||P.NEXT_PUBLIC_BETTER_AUTH_URL||P.PUBLIC_BETTER_AUTH_URL||P.NUXT_PUBLIC_BETTER_AUTH_URL||P.NUXT_PUBLIC_AUTH_URL||(P.BASE_URL!=="/"?P.BASE_URL:void 0);if(n)return B(n,t);if(typeof window<"u"&&window.location)return B(window.location.origin,t)}let w=[],S=0;const x=4;let te=e=>{let t=[],r={get(){return r.lc||r.listen(()=>{})(),r.value},lc:0,listen(n){return r.lc=t.push(n),()=>{for(let a=S+x;a<w.length;)w[a]===n?w.splice(a,x):a+=x;let s=t.indexOf(n);~s&&(t.splice(s,1),--r.lc||r.off())}},notify(n,s){let a=!w.length;for(let i of t)w.push(i,r.value,n,s);if(a){for(S=0;S<w.length;S+=x)w[S](w[S+1],w[S+2],w[S+3]);w.length=0}},off(){},set(n){let s=r.value;s!==n&&(r.value=n,r.notify(s))},subscribe(n){let s=r.listen(n);return n(r.value),s},value:e};return r};const Fe=5,j=6,q=10;let Me=(e,t,r,n)=>(e.events=e.events||{},e.events[r+q]||(e.events[r+q]=n(s=>{e.events[r].reduceRight((a,i)=>(i(a),a),{shared:{},...s})})),e.events[r]=e.events[r]||[],e.events[r].push(t),()=>{let s=e.events[r],a=s.indexOf(t);s.splice(a,1),s.length||(delete e.events[r],e.events[r+q](),delete e.events[r+q])}),We=1e3,Je=(e,t)=>Me(e,n=>{let s=t(n);s&&e.events[j].push(s)},Fe,n=>{let s=e.listen;e.listen=(...i)=>(!e.lc&&!e.active&&(e.active=!0,n()),s(...i));let a=e.off;return e.events[j]=[],e.off=()=>{a(),setTimeout(()=>{if(e.active&&!e.lc){e.active=!1;for(let i of e.events[j])i();e.events[j]=[]}},We)},()=>{e.listen=s,e.off=a}});const He=typeof window>"u",Ve=(e,t,r,n)=>{const s=te({data:null,error:null,isPending:!0,isRefetching:!1,refetch:()=>a()}),a=()=>{const u=typeof n=="function"?n({data:s.get().data,error:s.get().error,isPending:s.get().isPending}):n;return r(t,{...u,async onSuccess(l){s.set({data:l.data,error:null,isPending:!1,isRefetching:!1,refetch:s.value.refetch}),await u?.onSuccess?.(l)},async onError(l){const{request:o}=l,c=typeof o.retry=="number"?o.retry:o.retry?.attempts,f=o.retryAttempt||0;c&&f<c||(s.set({error:l.error,data:null,isPending:!1,isRefetching:!1,refetch:s.value.refetch}),await u?.onError?.(l))},async onRequest(l){const o=s.get();s.set({isPending:o.data===null,data:o.data,error:null,isRefetching:!0,refetch:s.value.refetch}),await u?.onRequest?.(l)}})};e=Array.isArray(e)?e:[e];let i=!1;for(const u of e)u.subscribe(()=>{He||(i?a():Je(s,()=>(setTimeout(()=>{a()},0),i=!0,()=>{s.off(),u.off()})))});return s},Ge={proto:/"(?:_|\\u0{2}5[Ff]){2}(?:p|\\u0{2}70)(?:r|\\u0{2}72)(?:o|\\u0{2}6[Ff])(?:t|\\u0{2}74)(?:o|\\u0{2}6[Ff])(?:_|\\u0{2}5[Ff]){2}"\s*:/,constructor:/"(?:c|\\u0063)(?:o|\\u006[Ff])(?:n|\\u006[Ee])(?:s|\\u0073)(?:t|\\u0074)(?:r|\\u0072)(?:u|\\u0075)(?:c|\\u0063)(?:t|\\u0074)(?:o|\\u006[Ff])(?:r|\\u0072)"\s*:/,protoShort:/"__proto__"\s*:/,constructorShort:/"constructor"\s*:/},ze=/^\s*["[{]|^\s*-?\d{1,16}(\.\d{1,17})?([Ee][+-]?\d+)?\s*$/,Q={true:!0,false:!1,null:null,undefined:void 0,nan:Number.NaN,infinity:Number.POSITIVE_INFINITY,"-infinity":Number.NEGATIVE_INFINITY},Qe=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,7}))?(?:Z|([+-])(\d{2}):(\d{2}))$/;function Xe(e){return e instanceof Date&&!isNaN(e.getTime())}function Ye(e){const t=Qe.exec(e);if(!t)return null;const[,r,n,s,a,i,u,l,o,c,f]=t;let h=new Date(Date.UTC(parseInt(r,10),parseInt(n,10)-1,parseInt(s,10),parseInt(a,10),parseInt(i,10),parseInt(u,10),l?parseInt(l.padEnd(3,"0"),10):0));if(o){const d=(parseInt(c,10)*60+parseInt(f,10))*(o==="+"?-1:1);h.setUTCMinutes(h.getUTCMinutes()+d)}return Xe(h)?h:null}function Ze(e,t={}){const{strict:r=!1,warnings:n=!1,reviver:s,parseDates:a=!0}=t;if(typeof e!="string")return e;const i=e.trim();if(i[0]==='"'&&i.endsWith('"')&&!i.slice(1,-1).includes('"'))return i.slice(1,-1);const u=i.toLowerCase();if(u.length<=9&&u in Q)return Q[u];if(!ze.test(i)){if(r)throw new SyntaxError("[better-json] Invalid JSON");return e}if(Object.entries(Ge).some(([o,c])=>{const f=c.test(i);return f&&n&&console.warn(`[better-json] Detected potential prototype pollution attempt using ${o} pattern`),f})&&r)throw new Error("[better-json] Potential prototype pollution attempt detected");try{return JSON.parse(i,(c,f)=>{if(c==="__proto__"||c==="constructor"&&f&&typeof f=="object"&&"prototype"in f){n&&console.warn(`[better-json] Dropping "${c}" key to prevent prototype pollution`);return}if(a&&typeof f=="string"){const h=Ye(f);if(h)return h}return s?s(c,f):f})}catch(o){if(r)throw o;return e}}function Ke(e,t={strict:!0}){return Ze(e,t)}const et={id:"redirect",name:"Redirect",hooks:{onSuccess(e){if(e.data?.url&&e.data?.redirect&&typeof window<"u"&&window.location&&window.location)try{window.location.href=e.data.url}catch{}}}};function tt(e){const t=te(!1);return{session:Ve(t,"/get-session",e,{method:"GET"}),$sessionSignal:t}}const rt=e=>{const t="credentials"in Request.prototype,r=Be(e?.baseURL,e?.basePath),n=e?.plugins?.flatMap(d=>d.fetchPlugins).filter(d=>d!==void 0)||[],s=xe({baseURL:r,...t?{credentials:"include"}:{},method:"GET",jsonParser(d){return d?Ke(d,{strict:!1}):null},customFetchImpl:async(d,m)=>{try{return await fetch(d,m)}catch{return Response.error()}},...e?.fetchOptions,plugins:e?.disableDefaultFetchPlugins?[...e?.fetchOptions?.plugins||[],...n]:[et,...e?.fetchOptions?.plugins||[],...n]}),{$sessionSignal:a,session:i}=tt(s),u=e?.plugins||[];let l={},o={$sessionSignal:a,session:i},c={"/sign-out":"POST","/revoke-sessions":"POST","/revoke-other-sessions":"POST","/delete-user":"POST"};const f=[{signal:"$sessionSignal",matcher(d){return d==="/sign-out"||d==="/update-user"||d.startsWith("/sign-in")||d.startsWith("/sign-up")||d==="/delete-user"||d==="/verify-email"}}];for(const d of u)d.getAtoms&&Object.assign(o,d.getAtoms?.(s)),d.pathMethods&&Object.assign(c,d.pathMethods),d.atomListeners&&f.push(...d.atomListeners);const h={notify:d=>{o[d].set(!o[d].get())},listen:(d,m)=>{o[d].subscribe(m)},atoms:o};for(const d of u)d.getActions&&Object.assign(l,d.getActions?.(s,h,e));return{pluginsActions:l,pluginsAtoms:o,pluginPathMethods:c,atomListeners:f,$fetch:s,$store:h}};function nt(e,t,r){const n=t[e],{fetchOptions:s,query:a,...i}=r||{};return n||(s?.method?s.method:i&&Object.keys(i).length>0?"POST":"GET")}function st(e,t,r,n,s){function a(i=[]){return new Proxy(function(){},{get(u,l){const o=[...i,l];let c=e;for(const f of o)if(c&&typeof c=="object"&&f in c)c=c[f];else{c=void 0;break}return typeof c=="function"?c:a(o)},apply:async(u,l,o)=>{const c="/"+i.map(U=>U.replace(/[A-Z]/g,A=>`-${A.toLowerCase()}`)).join("/"),f=o[0]||{},h=o[1]||{},{query:d,fetchOptions:m,...O}=f,E={...h,...m},I=nt(c,r,f);return await t(c,{...E,body:I==="GET"?void 0:{...O,...E?.body||{}},query:d||E?.query,method:I,async onSuccess(U){await E?.onSuccess?.(U);const A=s?.find(p=>p.matcher(c));if(!A)return;const y=n[A.signal];if(!y)return;const k=y.get();setTimeout(()=>{y.set(!k)},10)}})}})}return a()}function ot(e){return e.charAt(0).toUpperCase()+e.slice(1)}function X(e){let t=ue(),r=e.subscribe(n=>{t.value=n});return ce()&&le(r),t}function it(e){return`use${ot(e)}`}function at(e){const{pluginPathMethods:t,pluginsActions:r,pluginsAtoms:n,$fetch:s,$store:a,atomListeners:i}=rt(e);let u={};for(const[f,h]of Object.entries(n))u[it(f)]=()=>X(h);function l(f){if(f){const h=X(n.$sessionSignal),d=e?.fetchOptions?.baseURL||e?.baseURL;let m=d?new URL(d).pathname:"/api/auth";return m=m==="/"?"/api/auth":m,m=m.endsWith("/")?m.slice(0,-1):m,f(`${m}/get-session`,{ref:h}).then(O=>({data:O.data,isPending:!1,error:O.error}))}return u.useSession()}const o={...r,...u,useSession:l,$fetch:s,$store:a};return st(o,s,t,n,i)}function ut(e){return{authorize(t,r="AND"){let n=!1;for(const[s,a]of Object.entries(t)){const i=e[s];if(!i)return{success:!1,error:`You are not allowed to access resource: ${s}`};if(Array.isArray(a))n=a.every(u=>i.includes(u));else if(typeof a=="object"){const u=a;u.connector==="OR"?n=u.actions.some(l=>i.includes(l)):n=u.actions.every(l=>i.includes(l))}else throw new ee("Invalid access control request");if(n&&r==="OR")return{success:n};if(!n&&r==="AND")return{success:!1,error:`unauthorized to access resource "${s}"`}}return n?{success:n}:{success:!1,error:"Not authorized"}},statements:e}}function ct(e){return{newRole(t){return ut(t)},statements:e}}const lt={user:["create","list","set-role","ban","impersonate","delete","set-password"],session:["list","revoke","delete"]},re=ct(lt),ne=re.newRole({user:["create","list","set-role","ban","impersonate","delete","set-password"],session:["list","revoke","delete"]}),se=re.newRole({user:[],session:[]}),ft={admin:ne,user:se},dt=e=>{if(e.userId&&e.options?.adminUserIds?.includes(e.userId))return!0;if(!e.permissions&&!e.permission)return!1;const t=(e.role||e.options?.defaultRole||"user").split(","),r=e.options?.roles||ft;for(const n of t)if(r[n]?.authorize(e.permission??e.permissions)?.success)return!0;return!1},ht=e=>{const t={admin:ne,user:se,...e?.roles};return{id:"admin-client",$InferServerPlugin:{},getActions:r=>({admin:{checkRolePermission:n=>dt({role:n.role,options:{ac:e?.ac,roles:t},permissions:n.permissions??n.permission})}}),pathMethods:{"/admin/list-users":"GET","/admin/stop-impersonating":"POST"}}},mt=at({fetchOptions:{onError:async e=>{const{response:t}=e;if(t.status===429){const r=t.headers.get("X-Retry-After");fe({statusCode:t.status,statusMessage:`Too many tries. Retry after ${r} seconds`,fatal:!0})}}},plugins:[ht()]});export{mt as a};
